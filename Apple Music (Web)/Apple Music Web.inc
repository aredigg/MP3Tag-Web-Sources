# iTunes API/Apple Music parser v 3.0ùõº for MP3Tag v3
# ¬© 2021-2022 All Rights Reserved
[Name]=Apple Music
[BasedOn]=https://music.apple.com/
[AlbumUrl]=
[WordSeparator]=+
[IndexFormat]=%_url%|%Artist%|%Album%|%_preview%|%Version%|%Tracks%|%Collection ID%|%Copyright%|%Store%|%Currency%|%Price%|%Year%|%Genre%
[Encoding]=url-utf-8

[ParserScriptIndex]=...

json "on"

# debug "on" "debug-index.txt"

json_select "resultCount"
IfNot "0"
	json_foreach "results"
	json_select "collectionType"
	If "Album"

		json_select "collectionViewUrl"
		Replace "?uo=4" ""
		Replace "&uo=4" ""
		SayRest
		Say "|"

		json_select "artistName"
		SayRest
		Say "|"

		json_select "collectionName"
		If ""
			json_select "collectionCensoredName"
		EndIf
		SayRest
		Say "|"

		json_select "collectionViewUrl"
		Replace "?uo=4" ""
		Replace "&uo=4" ""
		SayRest
		Say "|"

		json_select "collectionExplicitness"
		Replace "notExplicit" ""
		Replace "explicit" "Explicit"
		Replace "cleaned" "Cleaned"
		SayRest
		Say "|"

		json_select "trackCount"
		SayNextNumber
		Say "|"

		json_select "collectionId"
		SayNextNumber
		Say "|"

		json_select "copyright"
		SayRest
		Say "|"

		json_select "country"
		SayRest
		Say "|"

		json_select "currency"
		SayRest
		Say "|"

		json_select "collectionPrice"
		SayRest
		Say "|"

		json_select "releaseDate"
		SayNextNumber
		Say "|"

		json_select "primaryGenreName"
		SayRest
		SayNewline

	EndIf
	If "Compilation"

		json_select "collectionViewUrl"
		Replace "?uo=4" ""
		Replace "&uo=4" ""
		SayRest
		Say "|"

		json_select "artistName"
		SayRest
		Say "|"

		json_select "collectionName"
		If ""
			json_select "collectionCensoredName"
		EndIf
		SayRest
		Say "|"

		json_select "collectionViewUrl"
		Replace "?uo=4" ""
		Replace "&uo=4" ""
		SayRest
		Say "|"

		json_select "collectionExplicitness"
		Replace "notExplicit" "C"
		Replace "explicit" "C Explicit"
		Replace "cleaned" "C Cleaned"
		SayRest
		Say "|"

		json_select "trackCount"
		SayNextNumber
		Say "|"

		json_select "collectionId"
		SayNextNumber
		Say "|"

		json_select "copyright"
		SayRest
		Say "|"

		json_select "country"
		SayRest
		Say "|"

		json_select "currency"
		SayRest
		Say "|"

		json_select "collectionPrice"
		SayRest
		Say "|"

		json_select "releaseDate"
		SayNextNumber
		Say "|"

		json_select "primaryGenreName"
		SayRest
		SayNewline

	EndIf
	json_foreach_end
EndIf

[ParserScriptAlbum]=...

FindLine "<script type=\"application/json\" id=\"serialized-server-data\">"

RegexpReplace ".*<script type=\"application/json\" id=\"serialized-server-data\">\[(.*)\]<\/script>.*" "$1"

json "on" "current"

# debug "on" "debug-album.txt"

json_select_object "intent"
IfNot ""
	json_select_object "contentDescriptor"
	IfNot ""
		json_select "kind"
		If "album"
			json_select_object "identifiers"
			IfNot ""
				json_select "storeAdamID"
				IfNot ""
					OutputTo "ITUNESALBUMID"
					SayRest
				EndIf
				json_unselect_object
			EndIf
			json_select_object "locale"
			IfNot ""
				json_select "storefront"
				IfNot ""
					Replace "br" "143503"
					Replace "cn" "143465"
					Replace "dk" "143458"
					Replace "fi" "143447"
					Replace "fr" "143442"
					Replace "de" "143443"
					Replace "in" "143467"
					Replace "it" "143450"
					Replace "jp" "143462"
					Replace "kr" "143466"
					Replace "no" "143457"
					Replace "pl" "143478"
					Replace "pt" "143453"
					Replace "ru" "143469"
					Replace "es" "143454"
					Replace "se" "143456"
					Replace "tr" "143480"
					Replace "ae" "143481"
					Replace "gb" "143444"
					Replace "ua" "143492"
					Replace "us" "143441"
					Replace "vn" "143471"
					OutputTo "ITUNESCOUNTRYID"
					SayRest
				EndIf
				json_select "language"
				IfNot ""
					OutputTo "ITUNESLANGUAGEID"
					SayRest
				EndIf
				json_unselect_object
			EndIf
		EndIf
		json_unselect_object
	EndIf
	json_unselect_object
EndIf

json_select_object "data"
IfNot ""
	json_foreach "sections"
	
		json_select "itemKind"
		If "containerDetailHeaderLockup"
			json_foreach "items"
			
				json_select_object "artwork"
				IfNot ""
					json_select_object "dictionary"
					IfNot ""
						json_select "url"
						IfNot ""
							Replace "{w}" "7200"
							Replace "{h}" "7200"
							Replace "{f}" "jpg"
							OutputTo "COVERURL"
							SayRest
						EndIf
						json_select "textColor1"
						IfNot ""
							OutputTo "TEXTCOLOR"
							SayRest
						EndIf
						json_select "textColor2"
						IfNot ""
							OutputTo "TEXTCOLOR2"
							SayRest
						EndIf
						json_select "textColor3"
						IfNot ""
							OutputTo "TEXTCOLOR3"
							SayRest
						EndIf
						json_select "textColor4"
						IfNot ""
							OutputTo "TEXTCOLOR4"
							SayRest
						EndIf
						json_select "bgColor"
						IfNot ""
							OutputTo "BGCOLOR"
							SayRest
						EndIf
						json_unselect_object
					EndIf
					json_unselect_object
				EndIf
				
				OutputTo "ALBUM"
				json_select "title"
				SayRest
				
				json_foreach "subtitleLinks"
					json_select "title"
					OutputTo "SUBALBUM"
					SayRest
					Say "/"
					json_select_object "segue"
					IfNot ""
						json_select_object "destination"
						IfNot ""
							json_select_object "contentDescriptor"
							IfNot ""
								json_select "kind"
								If "artist"
									json_select_object "identifiers"
									IfNot ""
										json_select "storeAdamID"
										OutputTo "ITUNESARTISTID"
										SayRest
										Say "/"
										json_unselect_object
									EndIf
								EndIf
								json_unselect_object
							EndIf
							json_unselect_object
						EndIf
						json_unselect_object
					Else
						Set "COMPILATION"
						OutputTo "COMPILATION"
						Say "1"
					EndIf
				json_foreach_end
					
				json_select_object "modalPresentationDescriptor"
				IfNot ""
					OutputTo "HEADER"
					json_select "headerTitle"
					SayRest
					OutputTo "SUBHEADER"
					json_select "headerSubtitle"
					SayRest
					OutputTo "DESCRIPTION"
					json_select "paragraphText"
					SayRest
					json_unselect_object
				EndIf
				
				OutputTo "TOTALTRACKS"
				json_select "trackCount"
				SayNextNumber
				
				OutputTo "ALBUMADVISORY"
				json_select "showExplicitBadge"
				SayNextNumber
				
			json_foreach_end
		EndIf
		
		If "containerDetailTracklistFooterLockup"
			json_foreach "items"
			
				OutputTo "COPYRIGHT"
				json_select "description"
				SayRegexp "‚Ñó.*"
				If ""
					json_select "description"
					SayRegexp "¬©.*"
				EndIf
				
			json_foreach_end
		EndIf

		If "trackLockup"
			json_foreach "items"
				
				OutputTo "TRACKS"
				json_select "title"
				SayRest
				Say "|"
				
				OutputTo "TRACK"
				json_select "trackNumber"
				SayNextNumber
				Say "|"

				OutputTo "_LENGTH"
				json_select "duration"
				SayNextNumber
				Say "|"

				json_select_object "contentDescriptor"
				IfNot ""
					json_select "kind"
					OutputTo "ITUNESMEDIATYPE"
					If "song"
						Say "Normal"
					EndIf
					If "musicVideo"
						Say "Music Video"
					EndIf
					json_select_object "identifiers"
					IfNot ""
						OutputTo "ITUNESCATALOGID"
						json_select "storeAdamID"
						SayRest
						json_unselect_object
					EndIf
					json_unselect_object
				EndIf
				OutputTo "ITUNESMEDIATYPE"
				Say "|"
				OutputTo "ITUNESCATALOGID"
				Say "|"

				json_foreach "subtitleLinks"
					json_select "title"
					OutputTo "SUBARTIST"
					SayRest
					Say "/"
					json_select_object "segue"
					IfNot ""
						json_select_object "destination"
						IfNot ""
							json_select_object "contentDescriptor"
							IfNot ""
								json_select "kind"
								If "artist"
									json_select_object "identifiers"
									IfNot ""
										json_select "storeAdamID"
										OutputTo "ITUNESARTISTID"
										SayRest
										Say "/"
										json_unselect_object
									EndIf
								EndIf
								json_unselect_object
							EndIf
							json_unselect_object
						EndIf
						json_unselect_object
					EndIf
				json_foreach_end
				OutputTo "SUBARTIST"
				Say "|"
				OutputTo "ITUNESARTISTID"
				Say "|"
				
				OutputTo "COMPOSER"
				json_select "composer"
				SayRest
				Say "|"

				OutputTo "DISCNUMBER"
				json_select "discNumber"
				SayNextNumber
				Say "|"

				OutputTo "TOTALDISCS"
				json_select "discNumber"
				Set "TOTALDISCS"
				SayNextNumber

				OutputTo "ARTIST"
				json_select "artistName"
				SayRest
				Say "|"

				OutputTo "ALBUMARTIST"
				json_select "containerArtistName"
				Replace "Various Artists" ""
				Replace "Varios Artistas" ""
				Replace "V√°rios Artistas" ""
				Replace "V√°rios int√©rpretes" ""
				Replace "Áæ§Êòü" ""
				Replace "Áæ§Êòü" ""
				Replace "Eri Esitt√§ji√§" ""
				Replace "Multi-interpr√®tes" ""
				Replace "Verschiedene Interpreten" ""
				Replace "Verschillende artiesten" ""
				Replace "Artisti Vari" ""
				Replace "„É¥„Ç°„É™„Ç¢„Çπ„Éª„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà" ""
				Replace "Diverse Artister" ""
				Replace "–†–∞–∑–Ω—ã–µ –∞—Ä—Ç–∏—Å—Ç—ã" ""
				Replace "–†–∞–∑–Ω—ã–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏" ""
				Replace "ŒîŒπŒ¨œÜŒøœÅŒøŒπ Œ∫Œ±ŒªŒªŒπœÑŒ≠œáŒΩŒµœÇ" ""
				Replace "Blandade Artister" ""
				Replace "◊ê◊û◊†◊ô◊ù ◊©◊ï◊†◊ô◊ù" ""
				Replace "√áe≈üitli Sanat√ßƒ±lar" ""
				Replace "ŸÖÿÆÿ™ŸÑŸÅ ÿßŸÑŸÅŸÜÿßŸÜŸäŸÜ" ""
				Replace "ŸÅŸÜÿßŸÜŸàŸÜ ŸÖÿ™ŸÜŸàÿπŸàŸÜ" ""
				Replace "ŸÅŸÜÿßŸÜŸàŸÜ ŸÖÿ™ÿπÿØÿØŸàŸÜ" ""
				Replace "–†—ñ–∑–Ω—ñ –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ" ""
				Replace "‡∏£‡∏ß‡∏°‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô" ""
				Replace "Nhi·ªÅu Ngh·ªá Sƒ©" ""
				SayRest
				Say "|"
				
			json_foreach_end
		EndIf
		
	json_foreach_end
	
	json_select_object "data" # This must be a bug in mp3tag json parser
	
	json_select_object "seoData"
	IfNot ""
		
		OutputTo "YEAR"
		json_select "musicReleaseDate"
		SayRest

		OutputTo "QUALITY"
		json_select "quality"
		SayRest
		
		OutputTo "COMMENT"
		json_select "socialDescription"
		SayRest

		json_foreach "ogSongs"
			json_select_object "attributes"
			IfNot ""
				OutputTo "TRACKYEAR"
				json_select "releaseDate"
				SayRest
				Say "|"
	
				OutputTo "ISRC"
				json_select "isrc"
				SayRest
				Say "|"
	
				OutputTo "TRACKCOVERURL"
				json_select_object "artwork"
				IfNot ""
					json_select "url"
					IfNot ""
						Replace "{w}" "7200"
						Replace "{h}" "7200"
						Replace "{f}" "jpg"
						SayRest
					EndIf
					json_unselect_object
				EndIf
				Say "|"
	
				OutputTo "LANGUAGE"
				json_select "audioLocale"
				SayRest
				Say "|"
	
				OutputTo "GENRE"
				json_select_array "genreNames" 1
				SayRest
				Say "|"
				
				OutputTo "GENRES"
				json_select_array "genreNames" -1 ", "
				Replace ", Music" ""
				Replace ", Musiikki" ""
				Replace ", Musik" ""
				Replace ", Musikk" ""
				Replace ", Musique" ""
				Replace ", Muzyka" ""
				Replace ", M√ºzik" ""
				Replace ", M√∫sica" ""
				Replace ", –ú—É–∑–∏–∫–∞" ""
				SayRest
				Say "|"
				
				OutputTo "ATTRIBUTION"
				json_select "attribution"
				SayRest
				Say "|"

				OutputTo "SHOWMOVEMENT"
				json_select "workName"
				IfNot ""
					Say "1"
				EndIf
				Say "|"
			
				OutputTo "WORK"
				json_select "workName"
				SayRest
				Say "|"
				
				OutputTo "MOVEMENTNAME"
				json_select "movementName"
				SayRest
				Say "|"
				
				OutputTo "MOVEMENT"
				json_select "movementNumber"
				SayNextNumber
				Say "|"
			
				OutputTo "MOVEMENTTOTAL"
				json_select "movementCount"
				SayNextNumber
				Say "|"

				OutputTo "ITUNESADVISORY"
				json_select "contentRating"
				IfNot ""
					Replace "notExplicit" "0"
					Replace "explicit" "1"
					Replace "cleaned" "2"
					Replace "clean" "2"
					SayRest
				Else
					Say "0"
				EndIf
				Say "|"

				json_unselect_object
			EndIf
		json_foreach_end
		
		json_unselect_object
	EndIf
	
	json_unselect_object
EndIf
